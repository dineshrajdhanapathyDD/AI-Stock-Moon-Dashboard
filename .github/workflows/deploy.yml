name: Deploy Stock Moon Dashboard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests
      run: |
        echo "Running comprehensive test suite..."
        python test_complete_system.py
        
    - name: Build validation
      run: |
        echo "Validating build..."
        python build.py
        
    - name: Generate deployment artifacts
      run: |
        echo "Creating deployment package..."
        python -c "
import json
from datetime import datetime
build_info = {
    'build_time': datetime.now().isoformat(),
    'commit_sha': '${{ github.sha }}',
    'branch': '${{ github.ref_name }}',
    'status': 'success'
}
with open('build_info.json', 'w') as f:
    json.dump(build_info, f, indent=2)
print('âœ… Build artifacts created')
        "

  build-static-demo:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Generate static demo
      run: |
        echo "ðŸŽ¨ Generating static demo for GitHub Pages..."
        python generate_static_demo.py
        
    - name: Create GitHub Pages structure
      run: |
        echo "ðŸ“ Setting up GitHub Pages structure..."
        mkdir -p docs
        
        # Copy static demo to docs folder
        if [ -d "static-demo" ]; then
          cp -r static-demo/* docs/
        fi
        
        # Create additional pages
        cat > docs/README.md << 'EOF'
        # Stock Moon Dashboard - Live Demo
        
        This is a static demonstration of the Stock Moon Dashboard analyzing relationships between stock prices and lunar cycles.
        
        ## Features Demonstrated
        - Interactive stock price charts
        - Moon phase correlation analysis  
        - Statistical significance testing
        - 90-day historical data analysis
        
        ## Full Interactive Version
        For the complete dashboard with real-time data and all features:
        - [GitHub Repository](https://github.com/${{ github.repository }})
        - [Live Interactive Demo](https://your-app-name.render.com)
        
        ## Technology Stack
        - Python/Dash for web application
        - Plotly for interactive visualizations
        - Yahoo Finance API for stock data
        - Astronomical calculations for moon phases
        EOF
        
        # Create 404 page
        cat > docs/404.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Page Not Found - Stock Moon Dashboard</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        </head>
        <body class="bg-light">
            <div class="container mt-5">
                <div class="row justify-content-center">
                    <div class="col-md-6 text-center">
                        <h1 class="display-1">404</h1>
                        <h2>Page Not Found</h2>
                        <p class="lead">The page you're looking for doesn't exist.</p>
                        <a href="/" class="btn btn-primary">Go to Demo</a>
                        <a href="https://github.com/${{ github.repository }}" class="btn btn-outline-secondary">View on GitHub</a>
                    </div>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        echo "âœ… GitHub Pages structure created"
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'

  deploy-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-static-demo
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Display deployment info
      run: |
        echo "ðŸŽ‰ GitHub Pages deployment successful!"
        echo "ðŸ“Š Static demo URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ðŸ”— Repository: https://github.com/${{ github.repository }}"

  deployment-summary:
    needs: [test, deploy-pages]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deployment Summary
      run: |
        echo "ðŸš€ Stock Moon Dashboard Deployment Complete!"
        echo "=================================="
        echo ""
        echo "ðŸ“Š GitHub Pages Demo: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "ðŸ”— Additional Deployment Options:"
        echo "   â€¢ Render: https://render.com (Recommended for full app)"
        echo "   â€¢ Railway: https://railway.app"
        echo "   â€¢ Heroku: https://heroku.com"
        echo "   â€¢ Vercel: https://vercel.com"
        echo ""
        echo "ðŸ“‹ Next Steps:"
        echo "   1. âœ… Static demo is live on GitHub Pages"
        echo "   2. ðŸš€ Deploy full interactive app to preferred platform"
        echo "   3. ðŸ”— Update README with live demo links"
        echo ""
        echo "ðŸ’¡ The static demo shows core functionality."
        echo "   For real-time data and full features, deploy the Python app!"
