version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - echo "=== Pre-Build Phase ==="
            - echo "Installing system dependencies"
            - yum update -y
            - yum install -y python3 python3-pip
            - echo "Upgrading pip"
            - python3 -m pip install --upgrade pip
            - echo "Installing Python dependencies"
            - python3 -m pip install -r requirements.txt
            - echo "Verifying installations"
            - python3 --version
            - pip3 --version
        build:
          commands:
            - echo "=== Build Phase ==="
            - echo "Testing MCP tools"
            - python3 mcp_server.py list
            - echo "Testing stock database"
            - python3 test_stock_search.py
            - echo "Validating dashboard components"
            - python3 -c "from src.dashboard import app; print('✅ Dashboard import successful')"
            - python3 -c "from src.stock_database import stock_db; print(f'✅ Stock database loaded: {len(stock_db.stocks)} stocks')"
            - echo "Running comprehensive system test"
            - python3 test_complete_system.py
            - echo "Build completed successfully"
        postBuild:
          commands:
            - echo "=== Post-Build Phase ==="
            - echo "Creating startup script"
            - echo '#!/bin/bash' > start.sh
            - echo 'export PYTHONPATH=/opt/python:$PYTHONPATH' >> start.sh
            - echo 'export PORT=${PORT:-8050}' >> start.sh
            - echo 'export DASH_HOST=${DASH_HOST:-0.0.0.0}' >> start.sh
            - echo 'python3 app.py' >> start.sh
            - chmod +x start.sh
            - echo "Deployment preparation complete"
      artifacts:
        baseDirectory: /
        files:
          - '**/*'
        name: stock-moon-dashboard
      cache:
        paths:
          - ~/.cache/pip/**/*
          - .test_cache/**/*
    appRoot: /
    customHeaders:
      - pattern: '**/*'
        headers:
          - key: 'X-Frame-Options'
            value: 'DENY'
          - key: 'X-Content-Type-Options'
            value: 'nosniff'
          - key: 'Referrer-Policy'
            value: 'strict-origin-when-cross-origin'
          - key: 'Content-Security-Policy'
            value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.plot.ly; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://query1.finance.yahoo.com https://archive-api.open-meteo.com;"